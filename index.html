<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Grist Editable Print Labels</title>

    <!-- A template for showing printing labels in a Custom Widget in Grist. -->
    <!-- Uses Vue.js, store.js, and the Grist Plugin API -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.5.3/vue.min.js"></script>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>

    <script src="editable-labels.js?ver=1"></script>
    <link rel="stylesheet" href="editable-labels.css?ver=1">
  </head>
  <body>
    <div id="app">
      <div class="status" v-if="status">
        <template v-if="status === 'waiting'">
          <p>Waiting for data...</p>
        </template>
        <template v-else>
          {{ status }}
        </template>
      </div>
      <div class="header" v-else>
        <select id="labeltype" v-model="template" @change="save()">
          <option v-for="tmpl in templates" :value="tmpl">
          {{ tmpl.name }}
          </option>
        </select>
        <div class="header-controls">
          <button type="button" 
                  class="editor-toggle-btn" 
                  :class="{ active: visualEditorMode }"
                  @click="toggleVisualEditor()"
                  title="Toggle visual editor">
            {{ visualEditorMode ? 'âœŽ Edit' : 'ðŸŽ¨ Design' }}
          </button>
          <div id="options-btn" v-on:click="showOptions = true">âš™</div>
        </div>
      </div>
      <div v-show="showOptions" id="options-container" v-on:click="showOptions = false">
        <div id="options-popup" v-on:click.stop>
          <div class="option-row">
            <label>Leave initial blanks:</label>
            <input type="number" id="blanks" v-model="blanks" @change="save()" min="0">
          </div>
          <div class="option-row">
            <label>Font size:</label>
            <input type="number" id="fontsize" v-model="fontSize" @change="save()" min="8" max="24" step="0.5">
          </div>
          <div class="option-row">
            <label>Font color:</label>
            <input type="color" id="fontcolor" v-model="fontColor" @change="save()">
          </div>
          <div class="option-row">
            <label>Text alignment:</label>
            <select id="textalign" v-model="textAlign" @change="save()">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>
          <div class="option-row">
            <label>Line spacing:</label>
            <input type="number" id="linespacing" v-model="lineSpacing" @change="save()" min="1" max="3" step="0.1">
          </div>
          <div class="option-row">
            <label>Field separator:</label>
            <input type="text" id="separator" v-model="separator" @change="save()" placeholder=", ">
          </div>
          <div class="option-row">
            <label>Show field names:</label>
            <input type="checkbox" id="showfieldnames" v-model="showFieldNames" @change="save()">
          </div>
        </div>
      </div>
      <template v-if="labelData && !visualEditorMode">
        <div class="page-outer" v-for="(page, pageIndex) in arrangeLabels(labelData, template, blanks)">
          <div class="labelpage" :class="'page-' + template.id">
            <template v-for="(label, index) in page">
              <div class="label" :class="'label-' + template.id" v-if="label !== null">
                <div v-if="hasPositionedFields(label)" class="label-content-positioned">
                  <div v-for="field in label.fields" 
                       :key="field.columnId"
                       class="positioned-field"
                       :style="getPositionedFieldStyle(field)">
                    {{ formatField(field) }}
                  </div>
                </div>
                <div v-else 
                     class="label-content" 
                     :style="labelStyle"
                     :data-label-id="label.rowId + '-' + index">{{ getLabelText(label) }}</div>
              </div>
              <div class="label label-blank" :class="'label-' + template.id" v-else></div>
            </template>
          </div>
        </div>
      </template>
      <!-- Visual Editor Popup -->
      <div v-if="visualEditorMode" class="editor-popup-overlay" @click="closeEditor()">
        <div class="editor-popup" @click.stop>
          <div class="editor-popup-header">
            <h3>Label Designer</h3>
            <button @click="closeEditor()" class="close-btn">Ã—</button>
          </div>
          <div class="editor-popup-content">
            <div class="editor-label-container">
              <div class="label editor-label" :class="'label-' + template.id">
                <div class="label-editor">
                  <div v-for="(field, fieldIndex) in getEditorFields()" 
                       :key="field.columnId"
                       class="field-editor-element"
                       :style="getFieldPosition(field)"
                       @mousedown="startDrag($event, field)"
                       @click="selectField(field)"
                       :class="{ selected: selectedField && selectedField.columnId === field.columnId }">
                    <div class="field-content" :style="getFieldEditorStyle(field)">
                      {{ field.name }}
                    </div>
                    <div class="field-handle" v-if="selectedField && selectedField.columnId === field.columnId">
                      <div class="field-handle-dot"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <!-- Field Properties Panel -->
            <div v-if="selectedField" class="field-properties-panel-inline">
              <div class="properties-header">
                <span>Field: {{ selectedField.name }}</span>
                <button @click="selectedField = null" class="close-btn">Ã—</button>
              </div>
              <div class="properties-content">
                <div class="property-group">
                  <label>Font Size:</label>
                  <input type="number" 
                         v-model.number="selectedField.formatting.fontSize" 
                         @change="saveFieldFormatting()"
                         min="6" max="48" step="0.5">
                </div>
                <div class="property-group">
                  <label>Font Color:</label>
                  <input type="color" 
                         v-model="selectedField.formatting.color" 
                         @change="saveFieldFormatting()">
                </div>
                <div class="property-group">
                  <label>Alignment:</label>
                  <select v-model="selectedField.formatting.align" @change="saveFieldFormatting()">
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                  </select>
                </div>
                <div class="property-group">
                  <label>Font Weight:</label>
                  <select v-model="selectedField.formatting.fontWeight" @change="saveFieldFormatting()">
                    <option value="normal">Normal</option>
                    <option value="bold">Bold</option>
                  </select>
                </div>
                <div class="property-group">
                  <label>Position X (%):</label>
                  <input type="number" 
                         v-model.number="selectedField.position.x" 
                         @change="saveFieldFormatting()"
                         min="0" max="100" step="0.1">
                </div>
                <div class="property-group">
                  <label>Position Y (%):</label>
                  <input type="number" 
                         v-model.number="selectedField.position.y" 
                         @change="saveFieldFormatting()"
                         min="0" max="100" step="0.1">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

